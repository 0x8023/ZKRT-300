C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE 8023
OBJECT MODULE PLACED IN .\output\8023.obj
COMPILER INVOKED BY: H:\Program\keil\C51\BIN\C51.EXE program\8023.c LARGE DEBUG OBJECTEXTEND PRINT(.\8023.lst) OBJECT(.\
                    -output\8023.obj)

line level    source

   1          #include "./output/8023.h"
   2          struct str_state str_begin,str_now,str_next;//分别为:起始状态/当前状态/目标状态
   3          struct str_parameter str_cod={
   4              /*ui str_cod.mlinerqd*/500,//默认主函数巡线软起动时间为500毫秒
   5              /*ui str_cod.mlineqc*/300,//默认主函数巡线前冲时间为500毫秒
   6          
   7              /*ui str_cod.sj1xx*/600,
   8              /*ui str_cod.sj1xs*/1000,
   9          
  10              /*ui str_cod.py1qkq*/666,
  11              /*ui str_cod.py1kqz*/684,
  12              /*ui str_cod.py1zkh*/684,
  13              /*ui str_cod.py1khh*/666,
  14              /*ui str_cod.py1qz*/1310,
  15              /*ui str_cod.py1zh*/1310,
  16              /*ui str_cod.py1kqkh*/1480,
  17              /*ui str_cod.py1qkh*/2122,
  18              /*ui str_cod.py1kqh*/2122,
  19          };
  20          void fun_delay(ui par_value,enum varENU_del par_model){
  21   1          ui loc_con=par_value;
  22   1          switch(par_model){
  23   2              case del_us://微秒级延时
  24   2                  while(loc_con-->0){
  25   3                      _nop_();
  26   3                      _nop_();
  27   3                  }
  28   2                  return;
  29   2              case del_ms://毫秒级延时
  30   2                  while(loc_con-->0){
  31   3                      uc loc_i, loc_j;
  32   3                      _nop_();
  33   3                      _nop_();
  34   3                      loc_i=12;
  35   3                      loc_j=168;
  36   3                      do{
  37   4                          while(--loc_j);
  38   4                      }while(--loc_i);
  39   3                  }
  40   2                  return;
  41   2              case del_s://秒级延时
  42   2                  while(loc_con-->0){
  43   3                      uc loc_i, loc_j, loc_k;
  44   3                      loc_i=46;
  45   3                      loc_j=153;
  46   3                      loc_k=245;
  47   3                      do{
  48   4                          do{
  49   5                              while(--loc_k);
  50   5                          }while(--loc_j);
  51   4                      }while(--loc_i);
  52   3                  }
  53   2                  return;
  54   2              default:return;
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 2   

  55   2          }
  56   1      }//延时
  57          void fun_timer0init(){
  58   1          AUXR&=0x7F;
  59   1          TMOD&=0xF0;
  60   1          TMOD|=0x01;
  61   1          TL0=0xB0;
  62   1          TH0=0x3C;
  63   1          TF0=0;
  64   1      }//50毫秒定时器0初始化
  65          void fun_timer1init(){
  66   1          AUXR&=0xBF;
  67   1          TMOD&=0x0F;
  68   1          TMOD|=0x10;
  69   1          TL1=0xE0;
  70   1          TH1=0xB1;
  71   1          TF1=0;
  72   1      }//20毫秒定时器1初始化
  73          void fun_timer0(){
  74   1          TL0=0xB0;
  75   1          TH0=0x3C;
  76   1          _nop_();
  77   1      }//50毫秒定时器0处理函数
  78          void fun_timer1(){
  79   1          TL1=0xE0;
  80   1          TH1=0xB1;
  81   1          _nop_();
  82   1      }//20毫秒定时器1处理函数
  83          void fun_wait(){
  84   1          while(in_start==1);
  85   1          fun_delay(20,del_ms);
  86   1          while(in_start==0);
  87   1          fun_delay(256,del_ms);
  88   1      }//等待按键
  89          void fun_select(enum varENU_sel par_model){
  90   1          if(par_model==sel_58)
  91   1              out_switchselect=0;
  92   1          else if(par_model==sel_912)
  93   1              out_switchselect=1;
  94   1      }//传感器片选
  95          void fun_initialization(){
  96   1          CLK_DIV=0x00;//不分频
  97   1      
  98   1          P0M1=0xff;//P0用于输入
  99   1          P0M0=0x00;//P0不能输出
 100   1          
 101   1          P1M1=0x00;//P1口0-1双向，2中断输入，3-6输入，7输出
 102   1          P1M0=0xfc;//P1口2-7输出
 103   1      
 104   1          P2M1=0xf0;//P2口4-7输入
 105   1          P2M0=0x0f;//P2口0-3输出
 106   1      
 107   1          //PS_2=1;//手抓松传感器置1 $?$
 108   1          //PS_11=1;//升降位置3传感器置1 $?$
 109   1      
 110   1          out_en1=1;//电机1/3使能 $?$
 111   1          out_en2=1;//电机2/4使能 $?$
 112   1          //out_motorselect=1;//电机片选为1 $?$
 113   1          //fun_delay(del_ms,1);//延时1毫秒 $?$
 114   1          out_motorselect=0;//电机片选为0 $?$
 115   1          //PS_5=PS_1;// $?$
 116   1      
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 3   

 117   1          fun_pwminit();//PWM的初始化设置
 118   1          fun_timer0init();//初始化定时器0
 119   1          fun_timer1init();//初始化定时器1
 120   1          in_start=1;//按键置1
 121   1      
 122   1          fun_wait();
 123   1      }//初始化
 124          void fun_pwminit(){
 125   1          CCON=0x00;
 126   1          CH=0;
 127   1          CL=0;
 128   1          CMOD=0x00;
 129   1      }//PWM初始化
 130          void fun_pwmr(uc par_value){
 131   1          CCAP0H=CCAP0L=par_value*2.5;//控制输出的占空比
 132   1          CCAPM0=0X42;//8位PWM输出，无中断
 133   1          PCA_PWM0=0x00;
 134   1      }//右路PWM输出
 135          void fun_pwml(uc par_value){
 136   1          CCAP1H=CCAP1L=par_value*2.5;//控制输出的占空比
 137   1          CCAPM1=0X42;//8位PWM输出，无中断
 138   1          PCA_PWM1=0x00;
 139   1      }//左路PWM输出
 140          void fun_startdj(enum varENU_mot par_model,char par_speed){
 141   1          if(par_speed==0)
 142   1              return;
 143   1          else if(par_speed>100)
 144   1              par_speed=100;
 145   1          else if(par_speed<-100)
 146   1              par_speed=-100;
 147   1          switch(par_model){
 148   2              case mot_l://左轮电机
 149   2                  CR=1;
 150   2                  if(par_speed>0){
 151   3                      fun_pwml(par_speed);out_pwml=0;
 152   3                  }
 153   2                  else if(par_speed<0){
 154   3                      fun_pwml(cabs(par_speed));out_pwml=1;
 155   3                  }
 156   2                  break;
 157   2              case mot_r://右轮电机
 158   2                  CR=1;
 159   2                  if(par_speed>0){
 160   3                      fun_pwmr(par_speed);out_pwmr=0;
 161   3                  }
 162   2                  else if(par_speed<0){
 163   3                      fun_pwmr(cabs(par_speed));out_pwmr=1;
 164   3                  }
 165   2                  break;
 166   2              case mot_rl://左右轮同步
 167   2                  CR=1;
 168   2                  if(par_speed>0){
 169   3                      fun_pwml(par_speed);out_pwml=0;
 170   3                      fun_pwmr(par_speed);out_pwmr=0;
 171   3                  }
 172   2                  else if(par_speed<0){
 173   3                      fun_pwml(cabs(par_speed));out_pwml=1;
 174   3                      fun_pwmr(cabs(par_speed));out_pwmr=1;
 175   3                  }
 176   2                  break;
 177   2              case mot_dj1://正转为抓紧，反转为松开
 178   2                  out_motorselect=1;
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 4   

 179   2                  if(par_speed>0)
 180   2                      out_dir1=1;
 181   2                  else if(par_speed<0)
 182   2                      out_dir1=0;
 183   2                  out_en1=0;
 184   2                  break;
 185   2              case mot_dj2://正转是向无电机一方转,反转为向有电机一方转
 186   2                  out_motorselect=1;
 187   2                  if(par_speed>0)
 188   2                      out_dir2=1;
 189   2                  else if(par_speed<0)
 190   2                      out_dir2=0;
 191   2                  out_en2=0;
 192   2                  break;
 193   2              case mot_dj3://向上为正转,向下为反转
 194   2                  out_motorselect=0;
 195   2                  if(par_speed>0)
 196   2                      out_dir1=0;
 197   2                  else if(par_speed<0)
 198   2                      out_dir1=1;
 199   2                  out_en1=0;
 200   2                  break;
 201   2              case mot_dj4://顺时针为正转,逆时针为反转
 202   2                  out_motorselect=0;
 203   2                  if(par_speed>0)
 204   2                      out_dir2=0;
 205   2                  else if(par_speed<0)
 206   2                      out_dir2=1;
 207   2                  out_en2=0;
 208   2                  break;
 209   2              default:
 210   2                  break;
 211   2          }
 212   1      }//启动电机
 213          void fun_stop(enum varENU_mot par_model){
 214   1          switch(par_model){
 215   2              case mot_l:
 216   2                  fun_pwml(0);out_pwml=0;break;
 217   2              case mot_r:
 218   2                  fun_pwmr(0);out_pwmr=0;break;
 219   2              case mot_rl:
 220   2                  CR=0;
 221   2                  fun_pwmr(0);out_pwmr=0;
 222   2                  fun_pwml(0);out_pwml=0;
 223   2                  break;
 224   2              case mot_dj1:
 225   2                  out_motorselect=1;out_dir1=0;out_en1=1;break;
 226   2              case mot_dj2:
 227   2                  out_motorselect=1;out_dir2=0;out_en2=1;break;
 228   2              case mot_dj3:
 229   2                  out_motorselect=0;out_dir1=0;out_en1=1;break;
 230   2              case mot_dj4:
 231   2                  out_motorselect=0;out_dir2=0;out_en2=1;break;
 232   2              default:
 233   2                  break;
 234   2          }
 235   1      }//停止电机
 236          void fun_sz1(enum varENU_han par_model){
 237   1          if(par_model==han_s){//手抓松
 238   2              while(1){
 239   3                  fun_startdj(mot_dj1,-100);
 240   3                  while(in_s==1);
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 5   

 241   3                  fun_delay(20,del_ms);
 242   3                  if(in_s==0)
 243   3                      break;
 244   3              }
 245   2          }
 246   1          else{//手抓紧
 247   2              while(1){
 248   3                  fun_startdj(mot_dj1,100);
 249   3                  while(in_j==1);
 250   3                  fun_delay(20,del_ms);
 251   3                  if(in_j==0)
 252   3                      break;
 253   3              }
 254   2          }
 255   1          fun_stop(mot_dj1);
 256   1          str_begin.szzt=par_model;//存储运行结果
 257   1      }//手抓单步运动
 258          void fun_sj1(enum varENU_sjp par_model){
 259   1          if(par_model==str_begin.sjwz)
 260   1             return;
 261   1          switch(par_model){
 262   2              case sjp_wz1://升降位置1(最上位)
 263   2                  fun_startdj(mot_dj3,100);
 264   2                  fun_select(sel_58);
 265   2                  fun_delay(50,del_ms);
 266   2                  while(1){//只有向上
 267   3                      while(in_wz1==1);
 268   3                      fun_delay(20,del_ms);
 269   3                      if(in_wz1==0)
 270   3                          break;
 271   3                  }
 272   2                  break;
 273   2              case sjp_wz12:
 274   2                  if(par_model>str_begin.sjwz){
 275   3                      fun_startdj(mot_dj3,-100);
 276   3                      fun_delay(str_cod.sj1xx,del_ms);
 277   3                  }
 278   2                  else{//要去的地方在上面，向上走
 279   3                      fun_sj1(sjp_wz2);
 280   3                      fun_startdj(mot_dj3,100);
 281   3                      fun_delay(str_cod.sj1xs,del_ms);
 282   3                  }
 283   2                  break;
 284   2              case sjp_wz2://升降位置2
 285   2                  if(par_model>str_begin.sjwz)
 286   2                      fun_startdj(mot_dj3,-100);
 287   2                  else
 288   2                      fun_startdj(mot_dj3,100);
 289   2                  fun_select(sel_58);
 290   2                  fun_delay(50,del_ms);
 291   2                  while(1){//要去的地方比较靠下,向下走                    
 292   3                      while(in_wz2==1);
 293   3                      fun_delay(20,del_ms);
 294   3                      if(in_wz2==0)
 295   3                          break;
 296   3                  }
 297   2                  break;
 298   2              case sjp_wz23:
 299   2                  if(par_model>str_begin.sjwz){
 300   3                      fun_sj1(sjp_wz2);
 301   3                      fun_startdj(mot_dj3,-100);
 302   3                      fun_delay(str_cod.sj1xx,del_ms);
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 6   

 303   3                  }
 304   2                  else{//要去的地方在上面，向上走
 305   3                      fun_sj1(sjp_wz3);
 306   3                      fun_startdj(mot_dj3,100);
 307   3                      fun_delay(str_cod.sj1xs,del_ms);
 308   3                  }
 309   2                  break;
 310   2              case sjp_wz3://升降位置3
 311   2                  if(par_model>str_begin.sjwz)
 312   2                      fun_startdj(mot_dj3,-100);
 313   2                  else
 314   2                      fun_startdj(mot_dj3,100);
 315   2                  fun_select(sel_58);
 316   2                  fun_delay(50,del_ms);
 317   2                  while(1){
 318   3                      while(in_wz3==1);
 319   3                      fun_delay(20,del_ms);
 320   3                      if(in_wz3==0)
 321   3                          break;
 322   3                  }
 323   2                  break;
 324   2              case sjp_wz34:
 325   2                  if(par_model>str_begin.sjwz){
 326   3                      fun_sj1(sjp_wz3);
 327   3                      fun_startdj(mot_dj3,-100);
 328   3                      fun_delay(str_cod.sj1xx,del_ms);
 329   3                  }
 330   2                  else{//要去的地方在上面，向上走
 331   3                      fun_sj1(sjp_wz4);
 332   3                      fun_startdj(mot_dj3,100);
 333   3                      fun_delay(str_cod.sj1xs,del_ms);
 334   3                  }
 335   2                  break;
 336   2              case sjp_wz4://升降位置4
 337   2                  if(par_model>str_begin.sjwz)
 338   2                      fun_startdj(mot_dj3,-100);
 339   2                  else
 340   2                      fun_startdj(mot_dj3,100);
 341   2                  fun_select(sel_58);
 342   2                  fun_delay(50,del_ms);
 343   2                  while(1){
 344   3                      while(in_wz4==1);
 345   3                      fun_delay(20,del_ms);
 346   3                      if(in_wz4==0)
 347   3                          break;
 348   3                  }
 349   2                  break;
 350   2              case sjp_wz45:
 351   2                  if(par_model>str_begin.sjwz){
 352   3                      fun_sj1(sjp_wz4);
 353   3                      fun_startdj(mot_dj3,-100);
 354   3                      fun_delay(str_cod.sj1xx,del_ms);
 355   3                  }
 356   2                  else{//要去的地方在上面，向上走
 357   3                      fun_startdj(mot_dj3,100);
 358   3                      //fun_delay(str_cod.sj1xs,del_ms);
 359   3                  }
 360   2                  break;
 361   2              case sjp_wz5://升降位置5
 362   2                  fun_startdj(mot_dj3,-100);
 363   2                  fun_select(sel_912);
 364   2                  fun_delay(50,del_ms);
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 7   

 365   2                  while(1){//要去的地方比较靠下,向下走                
 366   3                      while(in_wz5==1);
 367   3                      fun_delay(20,del_ms);
 368   3                      if(in_wz5==0)
 369   3                          break;
 370   3                  }
 371   2                  break;
 372   2              default:
 373   2                  break;
 374   2          }
 375   1          fun_stop(mot_dj3);
 376   1          str_begin.sjwz=par_model;//存储运行结果
 377   1      }//升降单步运动
 378          void fun_py1(enum varENU_tra par_model){
 379   1          switch(par_model){
 380   2              case tra_q://前平移(没有电机的呢个方向)
 381   2                  while(1){
 382   3                      fun_startdj(mot_dj2,100);
 383   3                      while(in_qpy==1);
 384   3                      fun_delay(20,del_ms);
 385   3                      if(in_qpy==0)
 386   3                          break;
 387   3                  }
 388   2                  break;
 389   2              // case tra_kq:
 390   2              //     switch(str_begin.pywz){
 391   2              //         case tra_q:
 392   2              //             //fun_startdj(mot_dj2,-100);
 393   2              //             //D(666)
 394   2      
 395   2              //             break;
 396   2              //         case tra_z:
 397   2              //             break;
 398   2              //         case tra_kh:
 399   2              //             break;
 400   2              //         case tra_h:
 401   2              //             break;
 402   2              //     }
 403   2              //     break;
 404   2              // case tra_z:
 405   2              //     switch(str_begin.pywz){
 406   2              //         case tra_q:
 407   2              //             break;
 408   2              //         case tra_kq:
 409   2              //             break;
 410   2              //         case tra_kh:
 411   2              //             break;
 412   2              //         case tra_h:
 413   2              //             break;
 414   2              //     }
 415   2              //     break;
 416   2              // case tra_kh:
 417   2              //     switch(str_begin.pywz){
 418   2              //         case tra_q:
 419   2              //             break;
 420   2              //         case tra_kq:
 421   2              //             break;
 422   2              //         case tra_z:
 423   2              //             break;
 424   2              //         case tra_h:
 425   2              //             break;
 426   2              //     }
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 8   

 427   2              //     break;
 428   2              case tra_h://后平移(有电机的呢个方向)
 429   2                  while(1){
 430   3                      fun_startdj(mot_dj2,-100);
 431   3                      while(in_hpy==1);
 432   3                      fun_delay(20,del_ms);
 433   3                      if(in_hpy==0)
 434   3                          break;
 435   3                  }
 436   2                  break;
 437   2              default:
 438   2                  break;
 439   2          }
 440   1          fun_stop(mot_dj2);
 441   1          str_begin.pywz=par_model;//存储运行结果
 442   1      }//平移单步运动
 443          void fun_hz1(enum varENU_dir par_model){
 444   1          switch(par_model){
 445   2              case dir_up://回转至前方
 446   2                  switch(str_begin.hzfx){
 447   3                      case dir_down://现在在下方
 448   3                          fun_startdj(mot_dj4,-100);
 449   3                          fun_select(sel_912);
 450   3                          fun_delay(1,del_s);
 451   3                          while(1){
 452   4                              while(in_hz==1);
 453   4                              fun_delay(25,del_ms);
 454   4                              if(in_hz==0)
 455   4                                  break;
 456   4                          }
 457   3                          while(1){
 458   4                              while(in_hz==0);
 459   4                              fun_delay(25,del_ms);
 460   4                              if(in_hz==1)
 461   4                                  break;
 462   4                          }
 463   3                          while(1){
 464   4                              while(in_hz==1);
 465   4                              fun_delay(25,del_ms);
 466   4                              if(in_hz==0)
 467   4                                  break;
 468   4                          }
 469   3                          break;
 470   3                      case dir_left://现在在左边
 471   3                          fun_startdj(mot_dj4,100);
 472   3                          fun_select(sel_912);
 473   3                          fun_delay(1,del_s);
 474   3                          while(1){
 475   4                              while(in_hz==1);
 476   4                              fun_delay(25,del_ms);
 477   4                              if(in_hz==0)
 478   4                                  break;
 479   4                          }
 480   3                          break;
 481   3                      case dir_right://现在在右边
 482   3                          fun_startdj(mot_dj4,-100);
 483   3                          fun_select(sel_912);
 484   3                          fun_delay(1,del_s);
 485   3                          while(1){
 486   4                              while(in_hz==1);
 487   4                              fun_delay(25,del_ms);
 488   4                              if(in_hz==0)
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 9   

 489   4                                  break;
 490   4                          }
 491   3                          break;
 492   3                      default:
 493   3                          break;
 494   3                  }
 495   2                  break;
 496   2              case dir_down://要去下面
 497   2                  switch(str_begin.hzfx){
 498   3                      case dir_up://现在在上面
 499   3                          fun_startdj(mot_dj4,100);
 500   3                          fun_select(sel_912);
 501   3                          fun_delay(1,del_s);
 502   3                          while(1){
 503   4                              while(in_hz==1);
 504   4                              fun_delay(25,del_ms);
 505   4                              if(in_hz==0)
 506   4                                  break;
 507   4                          }
 508   3                          while(1){
 509   4                              while(in_hz==0);
 510   4                              fun_delay(25,del_ms);
 511   4                              if(in_hz==1)
 512   4                                  break;
 513   4                          }
 514   3                          while(1){
 515   4                              while(in_hz==1);
 516   4                              fun_delay(25,del_ms);
 517   4                              if(in_hz==0)
 518   4                                  break;
 519   4                          }
 520   3                          break;
 521   3                      case dir_left://现在在左面
 522   3                          fun_startdj(mot_dj4,-100);
 523   3                          fun_select(sel_912);
 524   3                          fun_delay(1,del_s);
 525   3                          while(1){
 526   4                              while(in_hz==1);
 527   4                              fun_delay(25,del_ms);
 528   4                              if(in_hz==0)
 529   4                                  break;
 530   4                          }
 531   3                          break;
 532   3                      case dir_right://现在在右面
 533   3                          fun_startdj(mot_dj4,100);
 534   3                          fun_select(sel_912);
 535   3                          fun_delay(1,del_s);
 536   3                          while(1){
 537   4                              while(in_hz==1);
 538   4                              fun_delay(25,del_ms);
 539   4                              if(in_hz==0)
 540   4                                  break;
 541   4                          }
 542   3                          break;
 543   3                      default:
 544   3                          break;
 545   3                  }
 546   2                  break;
 547   2              case dir_left://要去左边
 548   2                  switch(str_begin.hzfx){
 549   3                      case dir_up://现在在上面
 550   3                          fun_startdj(mot_dj4,-100);
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 10  

 551   3                          fun_select(sel_912);
 552   3                          fun_delay(1,del_s);
 553   3                          while(1){
 554   4                              while(in_hz==1);
 555   4                              fun_delay(25,del_ms);
 556   4                              if(in_hz==0)
 557   4                                  break;
 558   4                          }
 559   3                          break;
 560   3                      case dir_down://现在在下面
 561   3                          fun_startdj(mot_dj4,100);
 562   3                          fun_select(sel_912);
 563   3                          fun_delay(1,del_s);
 564   3                          while(1){
 565   4                              while(in_hz==1);
 566   4                              fun_delay(25,del_ms);
 567   4                              if(in_hz==0)
 568   4                                  break;
 569   4                          }
 570   3                          break;
 571   3                      case dir_right://现在在右面
 572   3                          fun_startdj(mot_dj4,-100);
 573   3                          fun_select(sel_912);
 574   3                          fun_delay(1,del_s);
 575   3                          while(1){
 576   4                              while(in_hz==1);
 577   4                              fun_delay(25,del_ms);
 578   4                              if(in_hz==0)
 579   4                                  break;
 580   4                          }
 581   3                          while(1){
 582   4                              while(in_hz==0);
 583   4                              fun_delay(25,del_ms);
 584   4                              if(in_hz==1)
 585   4                                  break;
 586   4                          }
 587   3                          while(1){
 588   4                              while(in_hz==1);
 589   4                              fun_delay(25,del_ms);
 590   4                              if(in_hz==0){
 591   5                                  break;
 592   5                              }
 593   4                          }
 594   3                          break;
 595   3                      default:
 596   3                          break;
 597   3                  }
 598   2                  break;
 599   2              case dir_right://要去右面
 600   2                  switch(str_begin.hzfx){
 601   3                      case dir_up://现在在前面
 602   3                          fun_startdj(mot_dj4,100);
 603   3                          fun_select(sel_912);
 604   3                          fun_delay(1,del_s);
 605   3                          while(1){
 606   4                              while(in_hz==1);
 607   4                              fun_delay(25,del_ms);
 608   4                              if(in_hz==0)
 609   4                                  break;
 610   4                          }
 611   3                          break;
 612   3                      case dir_down://现在在下面
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 11  

 613   3                          fun_startdj(mot_dj4,-100);
 614   3                          fun_select(sel_912);
 615   3                          fun_delay(1,del_s);
 616   3                          while(1){
 617   4                              while(in_hz==1);
 618   4                              fun_delay(25,del_ms);
 619   4                              if(in_hz==0)
 620   4                                  break;
 621   4                          }
 622   3                          break;
 623   3                      case dir_left://现在在左面
 624   3                          fun_startdj(mot_dj4,100);
 625   3                          fun_select(sel_912);
 626   3                          fun_delay(1,del_s);
 627   3                          while(1){
 628   4                              while(in_hz==1);
 629   4                              fun_delay(25,del_ms);
 630   4                              if(in_hz==0)
 631   4                                  break;
 632   4                          }
 633   3                          while(1){
 634   4                              while(in_hz==0);
 635   4                              fun_delay(25,del_ms);
 636   4                              if(in_hz==1)
 637   4                                  break;
 638   4                          }
 639   3                          while(1){
 640   4                              while(in_hz==1);
 641   4                              fun_delay(25,del_ms);
 642   4                              if(in_hz==0){
 643   5                                  break;
 644   5                              }
 645   4                          }
 646   3                          break;
 647   3                      default:
 648   3                          break;
 649   3                  }
 650   2                  break;
 651   2              default:
 652   2                  break;
 653   2          }
 654   1          fun_stop(mot_dj4);
 655   1          str_begin.hzfx=par_model;//存储运行结果
 656   1      }//回转单步运动
 657          void fun_mptline(uc par_num,uc par_sd,enum varENU_dir par_model){
 658   1          bit loc_flag=0;
 659   1          ui loc_i;
 660   1          uc loc_con=0;
 661   1          uc loc_l=par_sd,loc_r=par_sd;
 662   1          for(loc_i=2;loc_i<par_sd;fun_startdj(mot_rl,loc_i++))//软起动
 663   1              fun_delay(str_cod.mlinerqd/par_sd,del_ms);
 664   1          while(1){
 665   2              loc_l=par_sd;//恢复默认参数
 666   2              loc_r=par_sd;
 667   2              if((in_ls1&&in_ls7)||(in_ls2&&in_ls8)){//巡线计数
 668   3                  loc_flag=1;
 669   3                  if(loc_con>=par_num){
 670   4                      if(par_model==dir_left){//左转
 671   5                          fun_startdj(mot_l,-20);
 672   5                          fun_delay(500,del_ms);
 673   5                          while(1){
 674   6                              while(!in_ls4||!in_ls5);
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 12  

 675   6                              fun_delay(100,del_us);
 676   6                              if(in_ls4&&in_ls5){
 677   7                                  fun_stop(mot_rl);
 678   7                                  return;
 679   7                              }
 680   6                          }
 681   5                      }
 682   4                      else if(par_model==dir_right){
 683   5                          fun_startdj(mot_r,-20);
 684   5                          fun_delay(500,del_ms);
 685   5                          while(1){
 686   6                              while(!in_ls4||!in_ls5);
 687   6                              fun_delay(100,del_us);
 688   6                              if(in_ls4&&in_ls5){
 689   7                                  fun_stop(mot_rl);
 690   7                                  return;
 691   7                              }
 692   6                          }
 693   5                      }
 694   4                  }
 695   3              }
 696   2              else if(loc_flag==1){
 697   3                  if(++loc_con>=par_num){
 698   4                      if(par_model==dir_up){
 699   5                          for(loc_i=0;loc_i<str_cod.mlineqc;loc_i++){
 700   6                              loc_l=par_sd*0.7;//恢复默认参数
 701   6                              loc_r=par_sd*0.7;
 702   6                              if(in_ls3){//纠偏
 703   7                                  loc_l*=0.9;
 704   7                                  loc_r*=1.1;
 705   7                              }
 706   6                              if(in_ls6){
 707   7                                  loc_l*=1.1;
 708   7                                  loc_r*=0.9;
 709   7                              }
 710   6                              if(in_ls2){
 711   7                                  loc_l*=0.8;
 712   7                                  loc_r*=1.2;
 713   7                              }
 714   6                              if(in_ls7){
 715   7                                  loc_l*=1.2;
 716   7                                  loc_r*=0.8;
 717   7                              }
 718   6                              if(in_ls1){
 719   7                                  loc_l*=0.7;
 720   7                                  loc_r*=1.3;
 721   7                              }
 722   6                              if(in_ls8){
 723   7                                  loc_l*=1.3;
 724   7                                  loc_r*=0.7;
 725   7                              }
 726   6                              fun_startdj(mot_l,loc_l);//更新电机参数
 727   6                              fun_startdj(mot_r,loc_r);
 728   6                              fun_delay(1,del_ms);
 729   6                          }
 730   5                          fun_stop(mot_rl);
 731   5                          return;
 732   5                      }
 733   4                  }
 734   3                  loc_flag=0;
 735   3              }
 736   2              if(in_ls3){//纠偏
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 13  

 737   3                  loc_l*=0.9;
 738   3                  loc_r*=1.1;
 739   3              }
 740   2              if(in_ls6){
 741   3                  loc_l*=1.1;
 742   3                  loc_r*=0.9;
 743   3              }  
 744   2              if(in_ls2){
 745   3                  loc_l*=0.8;
 746   3                  loc_r*=1.2;
 747   3              }
 748   2              if(in_ls7){
 749   3                  loc_l*=1.2;
 750   3                  loc_r*=0.8;
 751   3              }
 752   2              if(in_ls1){
 753   3                  loc_l*=0.7;
 754   3                  loc_r*=1.3;
 755   3              }
 756   2              if(in_ls8){
 757   3                  loc_l*=1.3;
 758   3                  loc_r*=0.7;
 759   3              }
 760   2              fun_startdj(mot_l,loc_l);//更新电机参数
 761   2              fun_startdj(mot_r,loc_r);
 762   2          }
 763   1      }//主函数普通巡线
 764          void fun_stope2prom(){
 765   1          IAP_CONTR = 0;                  //关闭IAP功能
 766   1          IAP_CMD = 0;                    //清除命令
 767   1          IAP_TRIG = 0;                   //清除触发寄存器
 768   1          IAP_ADDRH = 0x80;               //数据指针指向非EEPROM区
 769   1          IAP_ADDRL = 0;                  //清除IAP地址
 770   1      }//关闭EEPROM功能(IapIdle)
 771          uc fun_reade2prom(ui par_add){
 772   1          uc loc_dat;                     //数据缓冲区
 773   1          IAP_CONTR = 0x83;               //打开EEPROM功能,设置等待时间
 774   1          IAP_CMD = 1;                    //设置EEPROM读命令
 775   1          IAP_ADDRL = par_add;            //设置EEPROM地址低八位
 776   1          IAP_ADDRH = par_add >> 8;       //设置EEPROM地址高八位
 777   1          IAP_TRIG = 0x5a;                //触发
 778   1          IAP_TRIG = 0xa5;                //再次触发
 779   1          fun_delay(10,del_us);           //稍等一会儿
 780   1          loc_dat = IAP_DATA;             //读出EEPROM中的数据
 781   1          fun_stope2prom();               //关闭EEPROM功能
 782   1          return loc_dat;                 //返回读取结果
 783   1      }//读取EEPROM数据
 784          void fun_writee2prom(ui par_add,uc par_dat){
 785   1          IAP_CONTR = 0x83;               //打开EEPROM功能,设置等待时间
 786   1          IAP_CMD = 2;                    //设置EEPROM写入命令
 787   1          IAP_ADDRL = par_add;            //设置EEPROM地址低八位
 788   1          IAP_ADDRH = par_add >> 8;       //设置EEPROM地址高八位
 789   1          IAP_DATA = par_dat;             //写入数据
 790   1          IAP_TRIG = 0x5a;                //触发
 791   1          IAP_TRIG = 0xa5;                //再次触发
 792   1          fun_delay(10,del_us);           //稍等一会儿
 793   1          fun_stope2prom();               //关闭EEPROM功能
 794   1      }//写EEPROM数据
 795          void fun_cleane2prom(ui par_add){
 796   1          IAP_CONTR = 0x83;               //打开EEPROM功能,设置等待时间
 797   1          IAP_CMD = 3;                    //设置EEPROM擦除命令
 798   1          IAP_ADDRL = par_add;            //设置EEPROM地址低八位
C51 COMPILER V9.01   8023                                                                  03/02/2015 22:46:19 PAGE 14  

 799   1          IAP_ADDRH = par_add >> 8;       //设置EEPROM地址高八位
 800   1          IAP_TRIG = 0x5a;                //触发
 801   1          IAP_TRIG = 0xa5;                //再次触发
 802   1          fun_delay(10,del_us);           //稍等一会儿
 803   1          fun_stope2prom();               //关闭EEPROM功能
 804   1      }//清除EEPROM数据
 805          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3106    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     47      16
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
